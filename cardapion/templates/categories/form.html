{% extends "base_dashboard.html" %}

{% block page_title %}{{ 'Editar' if category_id else 'Nova' }} Categoria{% endblock %}
{% block header_title %}{{ 'Editar' if category_id else 'Nova' }} Categoria{% endblock %}

{% block main_content %}
<div class="max-w-2xl mx-auto" x-data="categoryForm()">
    <!-- Header -->
    <div class="flex items-center space-x-3 mb-6">
        <button @click="goBack" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left text-xl"></i>
        </button>
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                {{ 'Editar' if category_id else 'Nova' }} Categoria
            </h1>
            <p class="text-gray-600 mt-1">
                {{ 'Atualize as informações da categoria' if category_id else 'Crie uma nova categoria para seus produtos' }}
            </p>
        </div>
    </div>

    <!-- Formulário -->
    <div class="bg-white shadow-neumorphism rounded-xl p-6">
        <form @submit.prevent="saveCategory" class="space-y-6">
            <!-- Nome da Categoria -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    Nome da Categoria *
                </label>
                <input 
                    type="text" 
                    id="name" 
                    x-model="form.name"
                    class="w-full px-4 py-3 bg-white shadow-neumorphism rounded-lg border-0 focus:ring-2 focus:ring-primary focus:outline-none transition-all duration-300"
                    placeholder="Ex: Pizzas, Bebidas, Sobremesas"
                    required
                >
                <p class="text-sm text-gray-500 mt-1">Nome que aparecerá no cardápio</p>
            </div>

            <!-- Tipo de Categoria -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Tipo de Categoria *
                </label>
                <div class="space-y-3">
                    <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                           :class="form.kitchen ? 'border-primary bg-primary-50' : ''">
                        <input 
                            type="radio" 
                            :value="true" 
                            x-model="form.kitchen"
                            class="sr-only"
                        >
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-fire text-orange-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Cozinha</p>
                                <p class="text-sm text-gray-600">Produtos que precisam ser preparados</p>
                            </div>
                        </div>
                        <div class="w-4 h-4 border-2 rounded-full flex items-center justify-center"
                             :class="form.kitchen ? 'border-primary bg-primary' : 'border-gray-300'">
                            <div x-show="form.kitchen" class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                    </label>

                    <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                           :class="!form.kitchen ? 'border-primary bg-primary-50' : ''">
                        <input 
                            type="radio" 
                            :value="false" 
                            x-model="form.kitchen"
                            class="sr-only"
                        >
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-store text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Não Cozinha</p>
                                <p class="text-sm text-gray-600">Produtos prontos (bebidas, sobremesas, etc.)</p>
                            </div>
                        </div>
                        <div class="w-4 h-4 border-2 rounded-full flex items-center justify-center"
                             :class="!form.kitchen ? 'border-primary bg-primary' : 'border-gray-300'">
                            <div x-show="!form.kitchen" class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Informações Adicionais -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                    <div class="text-sm text-blue-700">
                        <p class="font-medium mb-1">Sobre os tipos de categoria:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>Cozinha:</strong> Produtos que aparecerão na cozinha para preparo</li>
                            <li><strong>Não Cozinha:</strong> Produtos que são servidos diretamente</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
                <button 
                    type="button" 
                    @click="goBack"
                    class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-300"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar
                </button>
                
                <button 
                    type="submit" 
                    :disabled="loading || !isFormValid"
                    class="flex-1 bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span x-show="!loading">
                        <i class="fas fa-save mr-2"></i>
                        {{ 'Atualizar' if category_id else 'Criar' }} Categoria
                    </span>
                    <span x-show="loading" class="flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Salvando...
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Mensagens de feedback -->
    <div x-show="message" x-transition class="fixed top-4 right-4 z-50">
        <div class="max-w-md p-3 rounded-lg" :class="messageType === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'">
            <span x-text="message"></span>
        </div>
    </div>
</div>

<script>
function categoryForm() {
    return {
        categoryId: '{{ category_id or "" }}',
        form: {
            name: '',
            kitchen: true
        },
        loading: false,
        message: '',
        messageType: 'error',

        get isFormValid() {
            return this.form.name.trim().length > 0;
        },

        async init() {
            if (this.categoryId) {
                await this.loadCategory();
            }
        },

        async loadCategory() {
            try {
                const response = await fetch(`/api/categories/${this.categoryId}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.form = {
                        name: data.category.name,
                        kitchen: data.category.kitchen
                    };
                } else {
                    this.showMessage('Erro ao carregar categoria', 'error');
                    setTimeout(() => {
                        this.goBack();
                    }, 2000);
                }
            } catch (error) {
                console.error('Erro ao carregar categoria:', error);
                this.showMessage('Erro de conexão', 'error');
                setTimeout(() => {
                    this.goBack();
                }, 2000);
            }
        },

        async saveCategory() {
            if (!this.isFormValid) {
                this.showMessage('Por favor, preencha todos os campos obrigatórios', 'error');
                return;
            }

            this.loading = true;
            this.message = '';

            try {
                const url = this.categoryId ? `/api/categories/${this.categoryId}` : '/api/categories';
                const method = this.categoryId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.form)
                });

                const data = await response.json();

                if (response.ok) {
                    this.showMessage(
                        this.categoryId ? 'Categoria atualizada com sucesso!' : 'Categoria criada com sucesso!', 
                        'success'
                    );
                    setTimeout(() => {
                        this.goBack();
                    }, 1500);
                } else {
                    this.showMessage(data.error || 'Erro ao salvar categoria', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar categoria:', error);
                this.showMessage('Erro de conexão. Tente novamente.', 'error');
            } finally {
                this.loading = false;
            }
        },

        goBack() {
            window.location.href = '/categories';
        },

        showMessage(text, type) {
            this.message = text;
            this.messageType = type;
            setTimeout(() => {
                this.message = '';
            }, 5000);
        }
    }
}
</script>
{% endblock %}
